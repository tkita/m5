<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="./lib/reboot.css">
        <script type="text/jscript" src="./lib/jquery-3.1.1.min.js"></script>

        <script>
         function zero ( n ) {
             return ( '0' + n ).slice( -2 );
         }

         function getRadioValue ( name ) {
             var radio = document.getElementsByName( name );
             var v = '';
             for ( var i = radio.length; i--; ) {
                 if ( radio[i].checked ) {
                     v = radio[i].value;
                     break;
                 }
             }
             return v;
         }

         function removeAllChilds ( id ) {
             var dom = document.getElementById( id );
             while ( dom.firstChild ) {
                 dom.removeChild( dom.firstChild );
             }
             return dom;
         }

         function getStation ( id ) {
             $.ajax( { url: 'https://roote.ekispert.net/ja/api/station/' +
                            document.getElementById( id ).value,
                       type: 'GET' }
             ).done( function ( res, status, xhr ) {
                 var tbody = removeAllChilds( id + 's' )
                 res.ResultSet.Point.forEach ( function (p) {
                     var tr = document.createElement( 'tr' );
                     var td = document.createElement( 'td' );
                     if ( typeof( p.Station.Type ) == 'string' ) {
                         td.textContent = p.Station.Type;
                     } else {
                         td.textContent = p.Station.Type[ 'detail' ] + '_' +
                                          p.Station.Type[ 'text' ];
                     }
                     tr.appendChild ( td );

                     [ p.Station.code,
                       p.Station.Name,
                       p.Station.Yomi ].forEach( function ( text ) {
                           var td = document.createElement( 'td' );
                           td.textContent = text;
                           tr.appendChild ( td );
                       });
                     tr.setAttribute( 'onClick', 'selectStation(this,' + id + ');' );
                     tbody.appendChild( tr );
                 });
             });
         }

         function selectStation ( row, id ) {
             var id = id.getAttribute( 'id' );
             document.getElementById( 'Name_' + id ).textContent =
                 row.getElementsByTagName( 'td' )[2].textContent;
             document.getElementById( 'code_' + id ).textContent =
                 row.getElementsByTagName( 'td' )[1].textContent;
         }

         function ekispert () {
             var param = {};

             var station = true;
             [ 'dep', 'arr' ].forEach( function (e) {
                 var v = document.getElementById( 'code_' + e ).textContent;
                 if ( v ) {
                     param[ e + '_code' ] = v;
                     param[ e ] = 'foo'; // code が正しければ何でもよい様子
                 } else {
                     alert( '選択されていません: ' + e );
                     station = false;
                 }
             });

             if ( !station ) {
                 return;
             }

             [ 'express', 'highway', 'liner', 'local', 'plane',
               'provider', 'shinkansen', 'ship', 'sleep' ].forEach( function ( n ) {
                   if ( document.getElementById( n ).checked ) {
                       param[ n ] = 'true';
                   }
               });

             // 表示順　time=時間順, price=料金順, transfer=乗換回数順
             param[ 'sort' ] = getRadioValue( 'sort' );

             // 乗換時間　1=ゆっくり, 2=普通, 3=急いで
             param[ 'transfer' ] = '2';

             // 運賃表示　0=ＩＣカード優先, 1=現金
             param[ 'ticket_type' ] = '0';

             // 特急料金　1=グリーン席優先, 2=指定席優先, 3=自由席優先
             param[ 'surcharge' ] = '3';

             // dep=出発, arr=到着, first=始発, last=終電
             param[ 'type' ] = getRadioValue( 'type' );

             param[ 'yyyymm' ] = document.getElementById( 'yyyy' ).value +
                                 document.getElementById( 'mm' ).value;
             param[ 'day' ] = document.getElementById( 'day' ).value;
             param[ 'hour' ] = document.getElementById( 'hour' ).value;
             param[ 'minute10' ] = document.getElementById( 'minute' ).value.substr( 0, 1 );
             param[ 'minute1' ] = document.getElementById( 'minute' ).value.substr( 1, 1 );

             [
//               [ 'submit_btn', '検索' ],
//               [ 'utf8', '✓' ],
                 [ 'connect', 'true' ],
                 [ 'locale', 'ja' ],
                 [ 'via1', '' ],
                 [ 'via1_code', '' ],
                 [ 'via2', '' ],
                 [ 'via2_code', '' ]
             ].forEach( function ( ary ) {
                 param[ ary[0] ] = ary[1];
             });

             var p = '';
             Object.keys( param ).forEach( function ( key ) {
                 p = p + key + '=' + param[ key ] + '&';
             });
             window.open( 'https://roote.ekispert.net/ja/select?' + p.slice( 0, -1 ) );
         }

         function init () {
             var dt = new Date();

             document.getElementById( 'yyyy' ).value = dt.getFullYear();
             var sel = document.getElementById( 'yyyy' );
             for ( var i = 0; i < 3; i++ ) {
                 var opt = document.createElement( 'option' );
                 opt.value = dt.getFullYear() + i - 1 ;
                 opt.text = dt.getFullYear() + i - 1 ;
                 sel.appendChild( opt );
             }

             [ [ 'mm', 1, 13 ],
               [ 'day', 1, 32 ],
               [ 'hour', 0, 24 ],
               [ 'minute', 0, 60 ] ].forEach( function ( ary ) {
                   var sel = document.getElementById( ary[0] );
                   for ( var i = ary[1]; i < ary[2]; i++ ) {
                       var opt = document.createElement( 'option' );
                       opt.value = zero( i );
                       opt.text = zero( i );
                       sel.appendChild( opt );
                   }
               });
             
             $( '#yyyy' ).val( dt.getFullYear() );
             $( '#mm' ).val( zero( dt.getMonth() + 1 ) );
             $( '#day' ).val( zero( dt.getDate() ) );
             $( '#hour' ).val( '08' );
             $( '#minute' ).val( '30' );
         }
        </script>

        <style>
         body {
             padding: 0.5em;
         }

         article {
             background-color: #f2f2f2;
             margin-bottom: 1em;
             padding: 0.5em;
             box-shadow: 0px 2px 2px 0px rgba( 0, 0, 0, 0.16 ), 0px 0px 0px 1px rgba( 0, 0, 0, 0.08 );
         }

         section {
             margin-bottom: 0.5em;
         }

         .indent {
             margin-left: 1em;
         }

         .scrollArea {
             height: 10em;
             overflow-y: scroll;
             border: 1px solid black;
         }

         th, td {
             border: 1px solid black;
         }

         tbody tr:hover {
             background-color: yellow;
             cursor: pointer;
         }

         label {
             margin-right: 2em;
         }

         h1 {
             text-align: center;
         }

        </style>
    </head>

    <body onLoad="init();">
        <article>
            <section>
                出発: <input id="dep" type="text" onKeyUp="getStation('dep');">
            </section>

            <section class="indent scrollArea">
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <!-- <th>BaseName</th> -->
                            <th>code</th>
                            <th>Name</th>
                            <th>Yomi</th>
                        </tr>
                    </thead>
                    <tbody id="deps">
                    </tbody>
                </table>
            </section>

            <section class="indent">
                Selected = ( <span id="code_dep"></span> ) <span id="Name_dep"></span>
            </section>
        </article>


        <article>
            <section>
                到着: <input id="arr" type="text" onKeyUp="getStation('arr');">
            </section>

            <section class="indent scrollArea">
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <!-- <th>BaseName</th> -->
                            <th>code</th>
                            <th>Name</th>
                            <th>Yomi</th>
                        </tr>
                    </thead>
                    <tbody id="arrs">
                    </tbody>
                </table>
            </section>

            <section class="indent">
                Selected = ( <span id="code_arr"></span> ) <span id="Name_arr"></span>
            </section>
        </article>

        <article>
            <button onClick="ekispert();">Open ekispert.net</button>
        </article>

        <article>
            <h1>options</h1>
            <article>
                <label>
                    <input type="radio" name="sort" value="time" checked="checked">時間順
                </label>
                <label>
                    <input type="radio" name="sort" value="price">料金順
                </label>
                <label>
                    <input type="radio" name="sort" value="transfer">乗換回数順
                </label>
            </article>

            <article>
                <section>
                    <label>
                        <!-- <input id="yyyy" type="text">年 -->
                        <select id="yyyy"></select>年
                    </label>
                    <label>
                        <select id="mm"></select>月
                    </label>
                    <label>
                        <select id="day"></select>日
                    </label>
                    <label>
                        <select id="hour"></select>時
                    </label>
                    <label>
                        <select id="minute"></select>分
                    </label>
                </section>

                <section>
                    <label>
                        <input type="radio" name="type" value="dep">出発
                    </label>
                    <label>
                        <input type="radio" name="type" value="arr" checked="checked">到着
                    </label>
                    <label>
                        <input type="radio" name="type" value="first">始発
                    </label>
                    <label>
                        <input type="radio" name="type" value="last">終電
                    </label>
                </section>
            </article>

            <article>
                <label>
                    <input type="checkbox" id="shinkansen">新幹線
                </label>
                <label>
                    <input type="checkbox" id="express">有料特急
                </label>
                <label>
                    <input type="checkbox" id="local" checked="checked">路線バス
                </label>
                <label>
                    <input type="checkbox" id="highway">高速バス
                </label>
                <label>
                    <input type="checkbox" id="plane">飛行機
                </label>
                <label>
                    <input type="checkbox" id="provider">連絡バス
                </label>
                <label>
                    <input type="checkbox" id="liner">ライナー
                </label>
                <label>
                    <input type="checkbox" id="sleep">寝台列車
                </label>
                <label>
                    <input type="checkbox" id="ship">海路
                </label>
            </article>
        </article>
    </body>
</html>
