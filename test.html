<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11" />

        <script type="text/javascript"
                charset="utf-8"
                src="https://map.yahooapis.jp/js/V1/jsapi?appid=dj00aiZpPTVucG5sTDNqOE1sdiZzPWNvbnN1bWVyc2VjcmV0Jng9MGM-">
        </script>

        <style>
         body {
             display: flex;
         }

         nav {
             background-color: rgba(234, 233, 226, 1);
         }

         fieldset {
             border: 1px solid black;
         }

         .mb {
             margin-bottom: 2em;
         }

         .mb02 {
             margin-bottom: 0.2em;
         }

         ul {
             margin: 0.5em 0px 0.5em 0px;
             padding-left: 1em;
         }

         li {
             margin-bottom: 0.2em;
             font-size: small;
             font-family: monospace;
         }

         .block {
             display: block;
         }

         .align-right {
             margin: 0 0 0 auto;
         }

         #map {
             height: 800px;
             border: 1px solid black;
             flex: 1;
         }

         .yolp-ctrl {
             padding: 0.2em;
             background-color: black;
         }

         .yolp-ctrl li {
             padding-left: 0.5em;
             padding-right: 0.5em;
         }

        </style>

        <script type="text/javascript">
         var ymap;
         var routeLayer;

         var getText = function ( dom ) {
             var d = document.getElementById( dom );
             switch ( d.tagName ) {
                 case 'SPAN':
                     return d.textContent;
                     break;
                 case 'INPUT':
                     return d.value;
                     break;
                 default:
                     return false;
                     break;
             };
         };

         var setText = function ( dom, value ) {
             var d = document.getElementById( dom );
             switch ( d.tagName ) {
                 case 'SPAN':
                     d.textContent = value;
                     break;
                 case 'INPUT':
                     d.value = value;
                     break;
             };
             return value;
         };

         var fmtNumber = function ( num ) {
             return String( num ).replace( /(\d)(?=(\d\d\d)+(?!\d))/g, '$1,' );
         }

         var init = function () {
             var layerSets = {};
             layerSets[ 'myRailway' ] = new Y.LayerSet( '鉄道路線', [ new Y.StyleMapLayer( 'railway' ) ] );
             layerSets[ Y.LayerSetId.NORMAL ] = new Y.LayerSet( '地図', [ new Y.NormalLayer() ] );

             ymap = new Y.Map( 'map', {
                 layerSets: layerSets,
                 configure: { doubleClickZoom: false,
                              scrollWheelZoom: true,
                              continuousZoom: true,
                              singleClickPan: false,
                              dragging: true }
             } );
             ymap.drawMap( new Y.LatLng( 43.062087, 141.354333 ), 17, Y.LayerSetId.NORMAL );

             ymap.addControl( new Y.LayerSetControl() );
             ymap.addControl( new Y.ScaleControl() );

             ymap.bind( 'click', function ( latlng ) {
                 setText( 'lat', latlng[ 'Lat' ] );
                 setText( 'lon', latlng[ 'Lon' ] );
                 var marker = new Y.Marker( new Y.LatLng( latlng[ 'Lat' ], latlng[ 'Lon' ] ) );
                 ymap.addFeature( marker );
             });

             routeLayer = new Y.RouteSearchLayer();
             routeLayer.bind( 'drawend', function ( summary ) {
                 setText( 'dist', fmtNumber( summary.TotalDistance ) );
                 setText( 'time', summary.TotalTime );
             });
             ymap.addLayer( routeLayer );

         };

         var doGeocode = function ( dom ) {
             var geocoder = new Y.GeoCoder();
             geocoder.execute( { query: getText( dom + 'addr' ) },
                               function ( result ) {
                                   if ( result.features.length > 0 ) {
                                       setText( dom + 'name', result.features[0].name);
                                       setText( dom + 'lat', result.features[0].latlng[ 'Lat' ] );
                                       setText( dom + 'lon', result.features[0].latlng[ 'Lon' ] );
                                   }
                               } );
         };

         var move = function ( dom ) {
             [ 'lat', 'lon' ].forEach( function ( e ) {
                 setText( dom + e, getText(e) );
             });

             [ 'name', 'addr' ].forEach( function ( e ) {
                 setText( dom + e, '' );
             });
         };

         var getRoute = function () {
             var latlngs = [
                 new Y.LatLng( getText( 'dep_lat' ), getText( 'dep_lon' ) ),
                 new Y.LatLng( getText( 'arr_lat' ), getText( 'arr_lon' ) )
             ];

             var config = {
                 useCar: false
             };

             if ( document.getElementById( 'car' ).checked ) {
                 config.useCar = true;
             };

             routeLayer.execute( latlngs, config );
         };

         var itsmo = function () {
             // 世界測地系(GoogleMap) から 日本測地系 へ変換
             var lat = parseFloat( getText( 'lat' ) );
             var lon = parseFloat( getText( 'lon' ) );
             var x = lat + 0.000106961 * lat - 0.000017467 * lon - 0.004602017;
             var y = lon + 0.000046047 * lat + 0.000083049 * lon - 0.010041046;

             // 度表記 から 秒表記(its-mo)
             x = Math.floor( x * 3600 * 1000 );
             y = Math.floor( y * 3600 * 1000 );
             var url = 'https://www.its-mo.com/map/top_z/' + x + '_' + y + '_13//#top'
             window.open( url );
         };

        </script>
    </head>

    <body onLoad="init();">
        <nav>
            <fieldset class="mb">
                <legend>出発地点</legend>
                <input id="dep_addr" type="text" class="block mb02" size="40"
                       placeholder="漢字住所を入力">
                <button class="block align-right" onClick="doGeocode('dep_');">座標へ変換</button>
                <ul>
                    <li><span id="dep_name"></span></li>
                    <li><span id="dep_lat"></span></li>
                    <li><span id="dep_lon"></span></li>
                </ul>
            </fieldset>

            <fieldset class="mb">
                <legend>到着地点</legend>
                <input id="arr_addr" type="text" class="block mb02" size="40"
                       placeholder="漢字住所を入力">
                <button class="block align-right" onClick="doGeocode('arr_');">座標へ変換</button>
                <ul>
                    <li><span id="arr_name"></span></li>
                    <li><span id="arr_lat"></span></li>
                    <li><span id="arr_lon"></span></li>
                </ul>
            </fieldset>

            <fieldset class="mb">
                <legend>マウスクリックした地点</legend>
                <ul>
                    <li><span id="lat"></span></li>
                    <li><span id="lon"></span></li>
                </ul>
                <button onClick="move('dep_');">出発地点へセット</button>
                <button class="mb02" onClick="move('arr_');">到着地点へセット</button>
                <button class="block align-right" onClick="itsmo();">いつもNAVIで開く</button>
            </fieldset>

            <fieldset>
                <legend>ルート検索</legend>
                <label>
                    <input type="radio" name="type" value="walk">徒歩
                </label>
                <label>
                    <input id="car" type="radio" name="type" value="car" checked="checked">自動車
                </label>
                <button class="block align-right" onClick="getRoute();">ルート検索</button>
                <ul>
                    <li>総距離: <span id="dist"></span> メートル</li>
                    <li>総時間: <span id="time"></span> 分</li>
                </ul>
            </fieldset>
        </nav>

        <article id="map">
        </article>
    </body>
</html>
